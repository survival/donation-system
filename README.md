[![Build Status](https://travis-ci.org/survival/donation-system.svg?branch=master)](https://travis-ci.org/survival/donation-system)
[![Coverage Status](https://coveralls.io/repos/github/survival/donation-system/badge.svg)](https://coveralls.io/github/survival/donation-system)
[![Dependency Status](https://gemnasium.com/badges/github.com/survival/donation-system.svg)](https://gemnasium.com/github.com/survival/donation-system)
[![Maintainability](https://api.codeclimate.com/v1/badges/2ec16c0232fcd70d732a/maintainability)](https://codeclimate.com/github/survival/donation-system/maintainability)


# Donation System

This is the new donation system for the Survival International site.


## Installation

This gem is still under development and in an unstable state.
Hence, it is not in rubygems yet.

To install it, add this line to your application's Gemfile:

```ruby
gem 'donation-system', git: 'https://github.com/survival/donation-system'
```

and run `bundle install`. Then append `bundle exec` in front of any CLI command that requires this gem.


## Usage

```ruby
require 'donation_system'

Data = Struct.new(
  :type, :amount, :currency, :giftaid, :token,
  :name, :email,
  :address, :city, :state, :zip, :country,
  :method
)

data = Data.new(
  'one-off', '10.50', 'gbp', true, 'tok_visa',
  'Jane Doe', 'jane@doe.com',
  'Main Street, 1', 'London', 'London', 'Z1PC0D3', 'UK',
  'stripe'
)

errors = DonationSystem::Payment.attempt(data)

if errors.empty?
  # Do something cool
else
  # Log errors, maybe
end
```

For PayPal tokens, you need two things: a payment id, and a payer id, hence:

```ruby
PaypalToken = Struct.new(:payment_id, :payer_id)
token = PaypalToken.new('PAY-13J25512E99606838LJU7M4Y', 'DUFRQ8GWYMJXC')
```

If there are no errors, it means that:
* The payment was saved in your Stripe/PayPal account
* A thank you email was sent to the donor
* The relevant records were saved in Salesforce (a one-off donation and a new supporter if they didn't exist in the database)

The `data` that the gem consumes can be anything that responds to at least the following (all these should return strings except the giftaid, which is a boolean):

* `data.type`: The type of donation. Valid values: `'one-off'` for one-off donations or `'recurring'` for recurring dontaions.
* `data.amount`: The amount of money to be donated, in currency units. This can be an amount with cents, and will be converted to cents by the gem. For example: 10.50
* `data.currency`: The currency that the amount is in, should be a valid ISO 4217 code for currencies and supported by the Money gem, which is used by this gem to handle money. [Check here for a list of supported currencies in JSON format](https://github.com/RubyMoney/money/tree/e2773f7859b268965fa003e2630ed58e7e96ac58/config)
* `data.giftaid`: This can be true or false, depending if you allow the donors to [Gift Aid](https://en.wikipedia.org/wiki/Gift_Aid) their donation to you
* `data.token` is a one-use valid token generated by Stripe, or the payment and payer ids generated by PayPal. To get them you need to use their JavaScript libraries in the frontend
* `data.name`: the name of the donor
* `data.email`: the email of the donor
* `data.address`: the address of the donor
* `data.city`: the city of the donor
* `data.state`: the state of the donor
* `data.zip`: the zip code of the donor
* `data.country`: the country of the donor
* `data.method`: the payment method. Valid values: `'stripe'` for Stripe donations or `'paypal'` for PayPal donations.

Due to an error thrown by the `Money` gem ([see this issue](https://github.com/RubyMoney/money/issues/593)) you will also have to set this in some relevant place of your application:

```ruby
I18n.enforce_available_locales = false
```


## Credentials
For the gem to work you need to set some environment variables:

1. The Stripe API keys of your Stripe account:

    ```bash
    export STRIPE_SECRET_KEY=...
    export STRIPE_PUBLIC_KEY=...
    ```

1. The PayPal API keys of your PayPal account:

    ```bash
    export PAYPAL_MODE=... # 'sandbox' or 'live' only
    export PAYPAL_CLIENT_ID=...
    export PAYPAL_CLIENT_SECRET=...
    ```

1. Your email server data:

    ```bash
    export EMAIL_SERVER=...
    export EMAIL_USERNAME=...
    export EMAIL_PASSWORD=...
    ```

1. Some data from your Salesforce account:

    ```bash
    export SALESFORCE_HOST=...
    export SALESFORCE_USERNAME=...
    export SALESFORCE_PASSWORD=...
    export SALESFORCE_SECURITY_TOKEN=...
    export SALESFORCE_CLIENT_ID=...
    export SALESFORCE_CLIENT_SECRET=...
    export SALESFORCE_API_VERSION=...
    ```

These variables are set in Travis and Heroku as well so that the tests are green and the applicaiton runs. Everytime you need to add new credentials or update existing ones, remember to also update:

* The credentials repo (*test* credentials only)
* Travis (*test* credentials only)
* Heroku staging (*production* credentials only)
* Heroku production (*poduction* credentials only)


## Payment flows

### Stripe

Use their JavaScript library in the frontend (i.e., [Stripe Checkout custom integration](https://stripe.com/docs/checkout#integration-custom)) to send the supporter card data and receive a token for that card. Then send the form data and the token to your server and use this gem as in the example above to make the payment.


### PayPal

This gem uses [the new PayPal express checkout](https://developer.paypal.com/docs/integration/direct/express-checkout/integration-jsv4/upgrade-integration)

As opposed to Stripe, the PayPal REST SDK
[needs an extra previous step](https://developer.paypal.com/docs/api/quickstart/payments/)
where your server creates a payment and returns the id to the `checkout.js` library. PayPal doesn't allow you to have a custom button anymore, so you have to use their PayPal button, which will be injected in an `iframe`.

```ruby
require 'donation_system'

Data = Struct.new(:amount, :currency, :return_url, :cancel_url)
data = PaypalCreatorData.new(
  '12.345', 'gbp', 'https://your-return-url.com', 'https://your-cancel-url.com'
).freeze

result = DonationSystem::PaypalWrapper::PaymentCreator.execute(data)

if result.okay?
  # Pass the payment id (result.item.id ) to the checkout.js library
else
  # Log result.errors, maybe
end
```

The return url is an endpoint in your web application [where PayPal should send the supporter once they have authorized the payment](https://developer.paypal.com/docs/integration/direct/payments/paypal-payments/#get-payment-approval). The cancel url is another endpoint in your application where PayPal will send the user if they cancel the payment.

Once you have passed the payment id to the checkout.js library, a pop-up will open for the donor to authorize the payment. After authorization, Paypal will call the `onAuthorize` method in the client, where you can then use this gem as in the example above to make the payment.


# Development


## To initialise the project

You need to have `git` and `bundler` installed.

Run the setup script (**Beware:** Needs permissions to access the credentials repo):

```
. ./scripts/setup.sh
```

This script will:
* download the credentials
* run the credentials to set the environment
* run `bundle install` to install gems.
* run `bundle exec rake` to run the tests.


## Tests

You need to set your environment by running the credentials. These will be loaded when you run the `setup.sh` script, but will also be loaded when you run the tests as described below. Make sure your credentials are up to date:

```bash
cd credentials && git push origin master && cd -
```

Currently, when you run the tests, any HTTP request will be recorded once in `spec/cassettes`, which are then replayed every time you run the tests. So the first time that you run them, they will take a while, but once they are recorded, they should run fast. Also, the first time you run the tests, you need to be connected to the internet.

If you ever get any weird errors when running the tests, try removing the cassettes and then running the tests again:

```bash
rm -rf spec/cassettes
bundle exec rake
```

This folder is safe to delete as it will be regenerated by the tests if it doesn't exist.


### To run all tests and rubocop

```bash
. ./test.sh
```


### To run one file


```bash
bundle exec rspec path/to/test/file.rb && rubocop
```


### To run one test

```bash
bundle exec rspec path/to/test/file.rb:TESTLINENUMBER && rubocop
```


### To release a new version


To release a new version, update the version number in `version.rb`, and describe your changes in the changelog. Then run:

```bash
git tag -a VERSION_HERE -m "DESCRIPTION_HERE"
```

which will create a git tag for the version. Then push git commits and tags:

```bash
git push origin master --tags
```

and push the `.gem` file to [rubygems.org](https://rubygems.org):

```bash
gem build donation_system.gemspec
gem push donation_system-VERSION_HERE.gem
```


## Testing emails in production

You can send an email to any email address using the `test_email_server.rb` script, and making sure that you set your environment with an email server, username and password, by running the credentials:

```bash
. credentials/.email_server
bundle exec ruby scripts/test_email_server.rb 'YOUR_EMAIL_HERE'
```


## Contributing

Please check out our [contribution guides](https://github.com/survival/contributing-guides) and our [code of conduct](https://github.com/survival/contributing-guides/blob/master/code-of-conduct.md)


## License

[![License](https://img.shields.io/badge/mit-license-green.svg?style=flat)](https://opensource.org/licenses/mit)
MIT License
